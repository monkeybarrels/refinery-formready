name: Deploy Frontend to Staging (Firebase Preview)

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy'
        required: true
        default: 'development'
        type: string

env:
  NODE_VERSION: '20'
  FIREBASE_PROJECT: refinery-authentication
  GCP_PROJECT_ID: claim-ready-479014
  GCP_PROJECT_NUMBER: 836364975560
  WORKLOAD_IDENTITY_PROVIDER: 'projects/836364975560/locations/global/workloadIdentityPools/github-actions/providers/github-provider'
  SERVICE_ACCOUNT: 'terraform-cicd@claim-ready-479014.iam.gserviceaccount.com'

concurrency:
  group: deploy-frontend-staging-${{ github.event.inputs.branch }}
  cancel-in-progress: true

jobs:
  deploy:
    name: Build and Deploy to Firebase Preview Channel
    runs-on: ubuntu-latest
    environment: staging
    timeout-minutes: 30

    permissions:
      contents: read
      id-token: write
      pull-requests: write  # For PR comments

    steps:
      - name: Checkout selected branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          rm -rf node_modules package-lock.json
          npm install
          npm ci

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - name: Fetch Firebase API Key from Secret Manager
        id: firebase
        run: |
          FIREBASE_API_KEY=$(gcloud secrets versions access latest --secret="FIREBASE_API_KEY_STAGING" --project="${{ env.GCP_PROJECT_ID }}")
          if [ -z "$FIREBASE_API_KEY" ]; then
            echo "âŒ ERROR: Failed to fetch Firebase API Key from Secret Manager"
            exit 1
          fi
          echo "firebase_api_key=${FIREBASE_API_KEY}" >> $GITHUB_OUTPUT
          echo "âœ… Fetched Firebase API Key from Secret Manager (length: ${#FIREBASE_API_KEY})"

      - name: Create staging .env file
        run: |
          cat > .env << EOF
          NUXT_PUBLIC_API_URL=${{ vars.STAGING_API_URL || 'https://api-staging.claimready.io' }}
          NUXT_PUBLIC_AUTHORIZER_URL=${{ vars.AUTHORIZER_URL || 'https://auth.claimready.io' }}
          NUXT_PUBLIC_AUTHORIZER_CLIENT_ID=${{ secrets.AUTHORIZER_CLIENT_ID }}
          NUXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=${{ secrets.STRIPE_TEST_KEY }}
          NUXT_PUBLIC_POSTHOG_API_KEY=${{ secrets.POSTHOG_API_KEY }}
          NUXT_PUBLIC_POSTHOG_HOST=${{ vars.POSTHOG_HOST || 'https://us.i.posthog.com' }}
          # Firebase Configuration (for RTDB notifications)
          NUXT_PUBLIC_NOTIFICATION_PROVIDER=firebase-rtdb
          NUXT_PUBLIC_FIREBASE_PROJECT_ID=refinery-authentication
          NUXT_PUBLIC_FIREBASE_DATABASE_URL=https://refinery-authentication-default-rtdb.firebaseio.com
          NUXT_PUBLIC_FIREBASE_AUTH_DOMAIN=refinery-authentication.firebaseapp.com
          NUXT_PUBLIC_FIREBASE_API_KEY=${{ steps.firebase.outputs.firebase_api_key }}
          EOF
          echo "âœ… Created .env file"
          echo "ðŸ“‹ Verifying Firebase config in .env:"
          grep -E "NUXT_PUBLIC_FIREBASE|NUXT_PUBLIC_NOTIFICATION" .env | sed 's/API_KEY=.*/API_KEY=***HIDDEN***/' || echo "âš ï¸  Warning: Firebase vars not found in .env"

      - name: Build Nuxt app
        run: npm run generate

      - name: Validate build output
        run: |
          if [ ! -d ".output/public" ]; then
            echo "âŒ Build failed: .output/public not found"
            exit 1
          fi
          echo "âœ… Build successful: $(du -sh .output/public)"

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Extract branch name and SHA
        id: extract
        run: |
          BRANCH_NAME=$(echo "${{ github.event.inputs.branch }}" | sed 's/\//-/g')
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          CHANNEL_NAME="${BRANCH_NAME}-${SHORT_SHA}"
          echo "channel_name=${CHANNEL_NAME}" >> $GITHUB_OUTPUT

      - name: Deploy to Firebase preview channel
        id: deploy
        run: |
          CHANNEL_NAME="${{ steps.extract.outputs.channel_name }}"

          # Deploy to preview channel (30-day expiration)
          set +e  # Don't exit on error, we want to capture the output
          firebase hosting:channel:deploy ${CHANNEL_NAME} \
            --project ${{ env.FIREBASE_PROJECT }} \
            --expires 30d \
            --json > deploy-output.json 2>&1
          DEPLOY_EXIT_CODE=$?
          set -e

          # Show output for debugging
          echo "Firebase CLI output:"
          cat deploy-output.json

          # Check if deployment failed
          if [ $DEPLOY_EXIT_CODE -ne 0 ]; then
            echo "âŒ Firebase deployment failed with exit code $DEPLOY_EXIT_CODE"
            exit $DEPLOY_EXIT_CODE
          fi

          # Extract preview URL from JSON output
          PREVIEW_URL=$(cat deploy-output.json | jq -r '.result."refinery-formready-staging".url' || echo "")

          if [ -z "$PREVIEW_URL" ]; then
            # Fallback: construct URL manually
            PREVIEW_URL="https://refinery-formready-staging--${CHANNEL_NAME}-$(echo ${{ secrets.GCP_PROJECT_ID }} | cut -c1-8).web.app"
          fi

          echo "preview_url=${PREVIEW_URL}" >> $GITHUB_OUTPUT
          echo "âœ… Deployed to: ${PREVIEW_URL}"

      - name: Create deployment summary
        run: |
          echo "## Staging Deployment Complete! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Preview URL**: ${{ steps.deploy.outputs.preview_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Channel**: \`${{ steps.extract.outputs.channel_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Expiration**: 30 days" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.event.inputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Testing the Deployment" >> $GITHUB_STEP_SUMMARY
          echo "Visit the preview URL to test your changes before merging to production." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Delete Preview Channel" >> $GITHUB_STEP_SUMMARY
          echo "To delete this channel early:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "firebase hosting:channel:delete ${{ steps.extract.outputs.channel_name }} --project ${{ env.FIREBASE_PROJECT }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY