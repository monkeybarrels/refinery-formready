name: Deploy Frontend to Production (Firebase)

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.vscode/**'
      - '.github/**'
      - '!.github/workflows/deploy-production.yml'
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  FIREBASE_PROJECT: refinery-authentication
  GCP_PROJECT_ID: claim-ready-479014
  GCP_PROJECT_NUMBER: 836364975560
  WORKLOAD_IDENTITY_PROVIDER: 'projects/836364975560/locations/global/workloadIdentityPools/github-actions/providers/github-provider'
  SERVICE_ACCOUNT: 'terraform-cicd@claim-ready-479014.iam.gserviceaccount.com'

concurrency:
  group: deploy-frontend-production
  cancel-in-progress: false

jobs:
  deploy:
    name: Build and Deploy to Production
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 60

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          # Remove package-lock.json to handle cross-platform native bindings
          # oxc-parser requires platform-specific binaries that may not be in lock file
          # when generated on macOS (npm bug: https://github.com/npm/cli/issues/4828)
          rm -f package-lock.json
          rm -rf node_modules
          npm install

      - name: Create production .env file
        run: |
          cat > .env << EOF
          NUXT_PUBLIC_API_URL=https://api.claimready.io
          NUXT_PUBLIC_AUTHORIZER_URL=https://auth.claimready.io
          NUXT_PUBLIC_AUTHORIZER_CLIENT_ID=${{ secrets.AUTHORIZER_CLIENT_ID }}
          NUXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=${{ secrets.STRIPE_LIVE_KEY }}
          NUXT_PUBLIC_POSTHOG_API_KEY=${{ secrets.POSTHOG_API_KEY }}
          NUXT_PUBLIC_POSTHOG_HOST=https://us.i.posthog.com
          EOF

      - name: Build Nuxt app
        run: npm run generate

      - name: Validate build output
        run: |
          if [ ! -d ".output/public" ]; then
            echo "âŒ Build failed: .output/public not found"
            exit 1
          fi

          BUILD_SIZE=$(du -sh .output/public | cut -f1)
          FILE_COUNT=$(find .output/public -type f | wc -l)

          echo "âœ… Build successful"
          echo "   Size: ${BUILD_SIZE}"
          echo "   Files: ${FILE_COUNT}"

          # Basic validation - ensure index.html exists
          if [ ! -f ".output/public/index.html" ]; then
            echo "âŒ Missing index.html"
            exit 1
          fi

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Configure firebase.json for production
        run: |
          # Remove staging site from firebase.json to deploy to default site
          jq 'del(.hosting.site)' firebase.json > firebase.tmp && mv firebase.tmp firebase.json
          echo "Updated firebase.json for production:"
          cat firebase.json

      - name: Deploy to Firebase Hosting (Production)
        run: |
          firebase deploy \
            --only hosting \
            --project ${{ env.FIREBASE_PROJECT }} \
            --non-interactive

      - name: Extract deployment info
        id: info
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Create deployment summary
        run: |
          echo "## Production Deployment Complete! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Site**: https://claimready.io" >> $GITHUB_STEP_SUMMARY
          echo "- **Firebase URL**: https://refinery-authentication.web.app" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **SHA**: \`${{ steps.info.outputs.short_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: main" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Verification Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Visit https://claimready.io and verify the site loads" >> $GITHUB_STEP_SUMMARY
          echo "2. Test critical user flows (signup, login, analyze)" >> $GITHUB_STEP_SUMMARY
          echo "3. Check browser console for errors" >> $GITHUB_STEP_SUMMARY
          echo "4. Verify API connectivity" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Rollback Instructions" >> $GITHUB_STEP_SUMMARY
          echo "To rollback to previous version:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# List recent versions" >> $GITHUB_STEP_SUMMARY
          echo "firebase hosting:releases:list --project ${{ env.FIREBASE_PROJECT }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Rollback to previous version" >> $GITHUB_STEP_SUMMARY
          echo "firebase hosting:rollback --project ${{ env.FIREBASE_PROJECT }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Verify deployment health
        run: |
          echo "Waiting for deployment to propagate..."
          sleep 15

          # Try to fetch the site
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://refinery-authentication.web.app" || echo "000")

          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "âœ… Health check passed (HTTP $HTTP_STATUS)"
          else
            echo "âš ï¸ Health check returned HTTP $HTTP_STATUS"
            echo "The site may take a few minutes to fully propagate"
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Health Check" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: HTTP $HTTP_STATUS" >> $GITHUB_STEP_SUMMARY

          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "- **Result**: âœ… Site is live" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Result**: âš ï¸ Site may still be propagating" >> $GITHUB_STEP_SUMMARY
          fi